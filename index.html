<element name="smart-collection">
  <template>
    <style>
      @host {}
    </style>  
  </template>
  <script>
    (function(context) {

      function add(el, nodeName, props) {
        var element = document.createElement(nodeName),
        prop;

        if (props) {
          for (prop in props) {
            element[prop] = props[prop];
          }
        }
        el.appendChild(element);
      }

      function addBatch(el, nodeName, num) {
        for (var i = 0; i < num; i++) {
          add(el, nodeName);
        }
      }

      function addBatchWithProps(el, nodeName, propsList) {
        propsList.forEach(function(props) {
          add(el, nodeName, props);
        });
      }

      Polymer.register(context, {
        add: function(nodeName, secondParam) {
          switch (typeof secondParam) {
            case "undefined":
              add(this, nodeName);
              break;
            case "number":
              addBatch(this, nodeName, secondParam);
              break;
            case "object":
              if (Object.prototype.toString.call(secondParam).indexOf("Array") > -1) {
                addBatchWithProps(this, nodeName, secondParam);
              } else {
                add(this, nodeName, secondParam);
              }
              break;
          }
        },
        get: function(id) {
          return this.querySelector("#" + id);
        },
        remove: function(id) {
          this.removeChild(this.get(id));
        }
      });
    })(this);
  </script>
</element>

<element name="racer-element">
  <template>
    <style>
      @host {}
    </style>  
  </template>
  <script>
    Polymer.register(this, {
      ready: function() {
        var racer = (this.parentNode && this.parentNode.racer) || window.racer;
        if (racer) {
          this.racer = racer;
        }
      },
      set racer(racer) {
        var self = this;
        racer.ready(function(model) {
          self.model = model;
        });
      },
      set child(element) {
        while (this.firstElementChild) {
          this.removeChild(this.firstElementChild);
        }
        this.appendChild(element);
        if (this._model) {
          this.update();
        }
      },
      get child() {
        return this.firstElementChild;
      },
      set model(model) {
        var self = this;
        this._model = model;

        model.on("change", "*", this.onChange.bind(this));
        model.subscribe(function() {
          if (self.child) {
            self.update();
          }
          self.dispatchEvent(new Event("subscribed"));
        });
      },
      get model() {
        return this._model;
      },
      update: function(data) {
        this.child.model = data || this._model.get();
      },
      onChange: function(name, value) {
        if (!this.child || !this.child.model) return;
        this.child.model[name] = value;
      }
    });
  </script>
</element>

<element name="racer-collection" extends="racer-element">
  <template>
    <style>
      @host {}
    </style>  
    <smart-collection id="collection"></smart-collection>
  </template>
  <script>
    Polymer.register(this, {
      onItemDelete: function(id) {
        this.$.collection.remove(id);
      },
      onItemCreate: function(id) {
        var wrapper = document.createElement("racer-element");

        if (!this.childType) throw new Error("childType was not declared");
        wrapper.child = document.createElement(this.childType);
        wrapper.model = this._model.at(id);
        wrapper.id = id;
        this.$.collection.appendChild(wrapper);
      },
      onItemUpdate: function(id, data) {
        this.$.collection.get(id).update(data);
      },
      onChange: function(id, data) {
        if (this.$.collection.get(id)) {
          if (data) {
            this.onItemUpdate(id, data);
          } else {
            this.onItemDelete(id);
          }
        } else {
          this.onItemCreate(id);
        }
      }
    });
  </script>
</element>
