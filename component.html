<element name="racer-collection" extends="racer-element">
  <template>
    <style>
      @host {}
    </style>  
    <smart-collection id="collection"></smart-collection>
  </template>
  <script>
    Polymer.register(this, {
      add: function(id) {
        var wrapper = document.createElement("racer-element"),
        self = this;

        if (!this.childType) throw new Error("childType was not declared");
        wrapper.child = document.createElement(this.childType);
        wrapper.addEventListener("subscribe", function() {
          self.trigger("item:subscribe");
        });
        wrapper.model = this._model.at(id);
        wrapper.id = id;
        this.$.collection.appendChild(wrapper);
      },
      onSubscribe: function() {
        var key,
        data = this._model.get(),
        count = Object.keys(data).length,
        subscribed = 0,
        self = this;

        for (key in data) {
          this.add(key);
        }

        this.addEventListener("item:subscribe", function() {
          subscribed++;
          if (subscribed >= count) {
            subscribed = 0;
            self.trigger("items:subscribe");
          }
        });
      },
      onItemDelete: function(id) {
        this.$.collection.remove(id);
      },
      onItemCreate: function(id) {
        this.add(id);
      },
      onItemUpdate: function(id, data) {
        this.$.collection.get(id).update(data);
      },
      onChange: function(id, data) {
        if (this.$.collection.get(id)) {
          if (data) {
            this.trigger("item:update", id, data);
          } else {
            this.trigger("item:delete", id);
          }
        } else {
          this.trigger("item:create", id);
        }
      }
    });
  </script>
</element>
