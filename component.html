<element name="racer-collection" extends="racer-element" attributes="collectionType itemType">
  <script>
    Polymer.register(this, {
      len: 0,
      get items() {
        return this.collection.items;
      },
      get collection() {
        if (this.child) return this.child;
        this.child = document.createElement(this.collectionType || "div");
        if (!this.child.push) {
          this.child.push = function(node) {
            this.appendChild(node);
          };
        };
        if (!this.child.items) {
          Object.defineProperty(this.child, "items", {
            get: function() {
              return this.children;
            }
          });
        }
        return this.child;
      },
      create: function(model) {
        var index = this.len - 1;

        this._model.set(index, model || {});
        this.add(index);
        this.len++;
      },
      add: function(id) {
        var wrapper = document.createElement("racer-element"),
        self = this;

        if (!this.itemType) throw new Error("itemType was not declared");
        wrapper.child = document.createElement(this.itemType);
        wrapper.addEventListener("subscribe", function() {
          self.trigger("item:subscribe");
        });
        wrapper.model = this._model.at(id);
        wrapper.id = "r-" + id;
        this.collection.push(wrapper);
      },
      onSubscribe: function() {
        var key,
        data = this._model.get(),
        count = Object.keys(data).length,
        subscribed = 0,
        self = this;

        this.addEventListener("item:subscribe", function() {
          subscribed++;
          if (subscribed >= count) {
            subscribed = 0;
            self.trigger("items:subscribe");
          }
        });

        for (key in data) {
          this.add(key);
        }
        this.len = count;
      },
      onItemDelete: function(id) {
        this.collection.removeChild(this.collection.items[id]);
      },
      onItemCreate: function(id) {
        this.add(id);
      },
      onItemUpdate: function(id, data) {
        this.collection.items[id].update(data);
      },
      onChange: function(id, data) {
        if (this.collection.items[id]) {
          if (data) {
            this.trigger("item:update", id, data);
          } else {
            this.trigger("item:delete", id);
          }
        } else {
          this.trigger("item:create", id);
        }
      }
    });
  </script>
</element>
