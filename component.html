<element name="racer-collection" extends="racer-element" attributes="collectionType itemType">
  <script>
    Polymer.register(this, {
      get items() {
        return this.collection.items;
      },
      get collection() {
        if (this.child) return this.child;
        this.child = document.createElement(this.collectionType || "div");
        if (!this.child.push) {
          this.child.push = function(node) {
            this.appendChild(node);
          };
        };
        if (!this.child.items) {
          Object.defineProperty(this.child, "items", {
            get: function() {
              return this.children;
            }
          });
        }
        return this.child;
      },
      push: function(model) {
        var length = this._model.push(this.at, model || {});
        this.add(length - 1);
      },
      add: function(i) {
        var wrapper = document.createElement("racer-element"),
        self = this;

        if (!this.itemType) throw new Error("itemType was not declared");
        wrapper.child = document.createElement(this.itemType);
        wrapper.model = this._model.at(this.at + "." + i);
        wrapper.id = "r-" + i;
        this.collection.push(wrapper);
      },
      onModelLoad: function() {
        var key,
        data,
        i = 0;

        if (!this.at) throw new Error("at attribute must be specified");
        data = this._model.get(this.at);

        for (i = 0; i < data.length; i++) {
          this.add(i);
        };

        this.trigger("items:load");
      },
      onItemDelete: function(i) {
        this.collection.removeChild(this.collection.items[i]);
      },
      onItemCreate: function(i) {
        this.add(i);
      },
      onItemUpdate: function(i, data) {
        this.collection.items[i].update(data);
      },
      onChange: function(i, data) {
        this.trigger("item:update", i, data);
      },
      onInsert: function(i) {
        this.trigger("item:create", i);
      },
      onRemove: function(i) {
        this.trigger("item:delete", i);
      }
    });
  </script>
</element>
