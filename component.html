<element name="racer-list" extends="racer-element" attributes="listType itemType reverse">
  <script>
    Polymer.register(this, {
      get items() {
        return this.list.items;
      },
      get list() {
        if (this.child) return this.child;
        this.child = document.createElement(this.listType || "div");
        if (!this.child.insertAt) {
          this.child.insertAt = function(node, i) {
            if (i >= this.items.length) {
              this.appendChild(node);
            } else {
              this.insertBefore(node, this.items[i]);
            }
          };
        }
        if (!this.child.items) {
          this.child.items = this.child.children;
        }
        return this.child;
      },
      push: function(item) {
        this.insertAt(item, this.items.length);
      },
      unshift: function(item) {
        this.insertAt(item, 0);
      },
      insertAt: function(model, i) {
        var length = this._model.insert(this.at, i, model || {});
        this.add(length - 1);
      },
      add: function(i) {
        var wrapper = document.createElement("racer-element"),
        self = this;

        if (!this.itemType) throw new Error("itemType was not declared");
        wrapper.child = document.createElement(this.itemType);
        wrapper.model = this._model.at(this.at + "." + i);
        wrapper.id = "r-" + i;
        if (this.reverse) {
          i = this.items.length - i;
        }
        this.list.insertAt(wrapper, i);
      },
      onModelLoad: function() {
        var key,
        data,
        i = 0;

        if (!this.at) throw new Error("at attribute must be specified");
        data = this._model.get(this.at);

        for (i = 0; i < data.length; i++) {
          this.add(i);
        };

        this.trigger("items:load");
      },
      onItemDelete: function(i) {
        this.list.removeChild(this.list.items[i]);
      },
      onItemCreate: function(i) {
        this.add(i);
      },
      onItemUpdate: function(i, data) {
        this.list.items[i].update(data);
      },
      onChange: function(i, data) {
        this.trigger("item:update", i, data);
      },
      onInsert: function(i) {
        this.trigger("item:create", i);
      },
      onRemove: function(i) {
        this.trigger("item:delete", i);
      }
    });
  </script>
</element>
