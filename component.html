<element name="racer-list" extends="racer-element" attributes="itemType at reverse itemAttributes">
  <template>
    <smart-list id="list"></smart-list>
  </template>
  <script>
    function add(self, key) {
      var wrapper = document.createElement("racer-element"),
      attr;

      if (!self.itemType) throw new Error("itemType was not declared");
      wrapper.child = document.createElement(self.itemType);
      wrapper.model = self._model.at(self.at + "." + key);
      if (self.itemAttributes) {
        for (attr in self.itemAttributes) {
          wrapper.child[attr] = self.itemAttributes[attr];
        }
      }

      wrapper.id = "r-" + key;

      if (self._isArray) {
        if (self.reverse) {
          key = self.items.length - key;
        }
        self.$.list.insert(key, wrapper);
      } else {
        self.$.list[self.reverse ? "unshift" : "push"](wrapper);
      }
    }

    Polymer.register(this, {
      get items() {
        return this.$.list.items;
      },
      push: function(item) {
        var length = this.items.length;

        if (this._isArray) {
          this.insert(this.items.length, item);
        } else {
          while (this._model.get(this.at + "." + length)) {
            length += 1;
          }
          this.set(length, item);
        }
      },
      unshift: function(item) {
        if (!this._isArray) throw new Error("Can't unshift on an object!");
        this.insert(0, item);
      },
      insert: function(i, model) {
        if (!this._isArray) throw new Error("Can't insert on an object!");
        this._model.insert(this.at, i, model || {});
      },
      set: function(key, value) {
        this._model.set(this.at + "." + key, value);
      },
      get: function(id) {
        return this.$.list.get("r-" + id);
      },
      del: function(key) {
        if (this._isArray) {
          this._model.del(this.at, key, 1);
        } else {
          this._model.del(this.at + "." + key);
        }
      },
      onModelLoad: function() {
        var key,
        data,
        self = this;

        if (!this.at) throw new Error("at attribute must be specified");
        data = this._model.get(this.at);

        this._isArray = Array.isArray(data);

        Object.keys(data).forEach(function(key) {
          add(self, key);
        });

        this.trigger("items:load");
      },
      onItemDelete: function(key) {
        this.$.list.rm("r-" + key);
      },
      onItemCreate: function(key) {
        add(this, key);
      },
      onItemUpdate: function(key, data) {
        var item;

        if (this._isArray) {
          item = this.$.list.items[key];
        } else {
          item = this.get(key);
        }
        item.update(data);
      },
      onChange: function(key, data) {
        var ev = "";

        if (this._isArray) {
          ev = "update";
        } else {
          if (key.indexOf(".") > -1) return;
          if (data && this.get(key)) {
            ev = "update";
          } else {
            ev = "delete";
          }
        }

        this.trigger("item:" + ev, key, data);
      },
      onLoad: function(key) {
        if (this._isArray) return;
        this.trigger("item:create", key);
      },
      onInsert: function(i) {
        this.trigger("item:create", i);
      },
      onRemove: function(i) {
        this.trigger("item:delete", i);
      },
      reset: function() {
        this.items.forEach(function(item) {
          item.reset();
        });
      }
    });
  </script>
</element>
